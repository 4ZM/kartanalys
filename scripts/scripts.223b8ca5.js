"use strict";angular.module("kartanalysApp",["ngAnimate","ngRoute","ngSanitize","leaflet-directive","ngProgress"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/map.html",controller:"MapCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("kartanalysApp").controller("MapCtrl",["$scope","$http","$q","ngProgress",function(a,b,c,d){a.map={defaults:{tileLayer:"http://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png",maxZoom:18,zoomControlPosition:"bottomleft"},center:{lat:59.326142,lng:17.9820525,zoom:11}},a.busy=!1,a.lowLevel=5,a.highLevel=15,a.party="SD",a.lockHiLow=!1,a.minMax={SD:{min:100,max:0},V:{min:100,max:0},S:{min:100,max:0},MP:{min:100,max:0},FI:{min:100,max:0},C:{min:100,max:0},FP:{min:100,max:0},M:{min:100,max:0},KD:{min:100,max:0}};var e={SD:"blue",V:"red",S:"red",MP:"green",FI:"#808",C:"blue",FP:"blue",M:"blue",KD:"blue"},f=function(a){return parseFloat(a.replace(",","."))},g=function(b,c){var d=f(c[b+" proc"]);a.minMax[b].min=Math.min(a.minMax[b].min,d),a.minMax[b].max=Math.max(a.minMax[b].max,d)},h=function(a){var b=c.defer(),d={};return Papa.parse(a,{header:!0,delimiter:";",download:!0,step:function(a){var b=a.data[0];d[b.LAN+b.KOM+b.VALDIST]=b,"01"===b.LAN&&"80"===b.KOM&&(g("SD",b),g("V",b),g("S",b),g("MP",b),g("FI",b),g("C",b),g("FP",b),g("M",b),g("KD",b))},complete:function(){b.resolve(d)}}),b.promise},i=function(a){return b.get("data/valkretsar.geojson").then(function(b){return _(b.data.features).forEach(function(b){b.electionData=a[b.properties.VD]}),b.data.features})},j=function(b){function d(b,c){a.lockHiLow||(a.lowLevel=a.minMax[a.party].min,a.highLevel=a.minMax[a.party].max);var d=f(c.feature.electionData[a.party+" proc"]),g=b.properties.VD+": "+b.properties.VD_NAMN,h=(d-a.lowLevel)/(a.highLevel-a.lowLevel);h=Math.pow(h,1.3);var i=d<a.lowLevel?0:.9*Math.min(1,h),j=function(b){var d=1===b.length?"&nbsp;"+b:b,e=function(a){return 10>a?"&nbsp;"+a.toFixed(2):""+a.toFixed(2)};return"<br />"+(b===a.party?"<b>":"")+d+": "+e(f(c.feature.electionData[b+" proc"]))+"% ("+e(a.minMax[b].min)+"% - "+e(a.minMax[b].max)+"%)"+(b===a.party?"</b>":"")};c.bindPopup('<span style="font-family:monospace;">'+g+j("SD")+j("V")+j("S")+j("MP")+j("FI")+j("C")+j("FP")+j("M")+j("KD")+"</span>"),h>.2&&(c.options.fillColor=e[a.party],c.options.fillOpacity=i)}var g=c.defer(),h={geojson:{data:b,style:{weight:1,opacity:.3,color:"red",fillOpacity:0},onEachFeature:d,resetStyleOnMouseout:!0}};return g.resolve(h),g.promise};a.load=function(){a.busy=!0,d.start(),h("data/valdata.skv").then(i).then(j).then(function(b){d.complete(),angular.extend(a,b),a.busy=!1})}}]);